rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.role == 'admin' || 
              request.auth.token.role == 'super_admin');
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // School Leads - Public insert, admin read/update
    match /school_leads/{leadId} {
      allow create: if true; // Public can submit leads
      allow read, update: if isAdmin();
    }
    
    // Student Signups - Public insert, owner/admin read, admin update
    match /student_signups/{signupId} {
      allow create: if true; // Public can sign up
      allow read: if isAuthenticated() && (
                     isOwner(signupId) || 
                     isAdmin() ||
                     request.auth.token.email == resource.data.parent_email ||
                     request.auth.uid == signupId
                  );
      allow update: if isAdmin() || isOwner(signupId);
      allow delete: if isAdmin();
    }
    
    // Admin Users - Admin only
    match /admin_users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin();
    }
    
    // School Accounts - School owner and admin access
    match /school_accounts/{accountId} {
      allow read: if isOwner(accountId) || isAdmin();
      allow write: if isAdmin();
    }
    
    // Chat Conversations - Owner, related student, related school, or admin
    match /chat_conversations/{conversationId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid;
      
      allow read: if isAuthenticated() && (
        // User's own conversation
        resource.data.user_id == request.auth.uid ||
        // Student's own conversation
        resource.data.student_signup_id == request.auth.uid ||
        // Admin access
        isAdmin()
        // Note: School access would require a join query which Firestore doesn't support
        // This should be handled via Cloud Function or denormalized data
      );
      
      allow update: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        resource.data.student_signup_id == request.auth.uid
      );
    }
    
    // Chat Messages - Access through conversation
    match /chat_messages/{messageId} {
      allow create: if isAuthenticated();
      
      allow read: if isAuthenticated();
      
      allow update, delete: if isAdmin();
    }
    
    // Payment Proofs - Owner submit, admin approve
    match /payment_proofs/{proofId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid;
      
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        isAdmin()
      );
      
      allow update: if isAdmin();
    }
  }
}
